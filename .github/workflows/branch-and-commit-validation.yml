name: Branch and Commit Validation

on:
  workflow_dispatch: {}
  push:
    branches-ignore:
      - 'main'
      - 'staging'
      - 'develop'
      - 'prelaunch'
      - 'production'

jobs:
  validate:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate branch name
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Validating branch name..."
          bash ./scripts/.git-scripts/validate-branch.sh

      - name: Validate commit messages
        env:
          BEFORE_SHA: ${{ github.event.before }}
          CURRENT_SHA: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Validating commit names..."
          echo "Range: ${BEFORE_SHA:-<empty>}..${CURRENT_SHA}"

          if [ -z "${BEFORE_SHA:-}" ] || [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "No valid BEFORE_SHA, using single commit $CURRENT_SHA"
            range="$CURRENT_SHA"
          else
            if git cat-file -e "$BEFORE_SHA^{commit}" 2>/dev/null && git cat-file -e "$CURRENT_SHA^{commit}" 2>/dev/null; then
              if git merge-base --is-ancestor "$BEFORE_SHA" "$CURRENT_SHA"; then
                range="$BEFORE_SHA..$CURRENT_SHA"
              else
                echo "BEFORE_SHA is not an ancestor of CURRENT_SHA, falling back to single commit"
                range="$CURRENT_SHA"
              fi
            else
              echo "One of the SHAs is not present locally (likely shallow/force-push). Falling back to single commit."
              range="$CURRENT_SHA"
            fi
          fi

          if [ "$range" = "$CURRENT_SHA" ]; then
            commits=$(git log --format=%s --no-merges -1 "$CURRENT_SHA")
          else
            commits=$(git log --format=%s --no-merges "$range")
          fi

          echo "Commits to validate:"
          echo "$commits"

          while IFS= read -r commit_msg; do
            [ -z "$commit_msg" ] && continue
            echo "Checking: $commit_msg"
            bash ./scripts/.git-scripts/validate-commit.sh "$commit_msg"
          done <<< "$commits"
