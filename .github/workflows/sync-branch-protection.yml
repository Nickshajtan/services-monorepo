name: Sync branch protection
on:
  workflow_dispatch: {}
  push:
    paths:
      - '.github/branch-protection.yml'
      - '.github/branch-protection.yaml'
      - '.github/branch-protection.json'
      - 'scripts/infrastructure/sync-branch-protection.cjs'

jobs:
  sync-branch-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      administration: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Ensure critical config edited by allowed actor
        run: |
          echo "Checking who modified critical files..."
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} -- .github/branch-protection.yml scripts/infrastructure .github/workflows)
          if [ -z "$CHANGED" ]; then
            echo "No critical files changed."
            exit 0
          fi

          echo "Critical files changed:"
          echo "$CHANGED"
          AUTHOR="${{ github.actor }}"
          case "$AUTHOR" in
            Nickshajtan|some_other_senior)
              echo "Author $AUTHOR is allowed to edit critical configs."
              exit 0
            ;;
            *)
              echo "Author $AUTHOR is NOT allowed to change critical configs."
              exit 1
            ;;
          esac

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install deps
        run: yarn install --immutable --ignore-scripts

      - name: Sync branch protection
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/infrastructure/sync-branch-protection.cjs
